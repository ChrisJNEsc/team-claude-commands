# Analyze-Bug Session: ACC-579

**Date:** 2025-12-22
**Command Version (Hash):** 371156f
**Linear Issue:** ACC-579
**Classification:** Backend
**Outcome:** Ticket Created

---

## Session Summary

Customer reported Profit Tracker showing actual revenue of $37,358.65 when only $25,746.97 in payments were logged. Investigation identified root cause in `payments-backend` where payment aggregation logic double-counts payments that exist both directly on a job AND linked through invoice relationships. Created Linear ticket ACC-579 with detailed analysis and proposed fix.

---

## User Inputs

**Input 1: Initial Report**
> Support - Web Escalation
> Troubleshooting Steps Taken:
> Logout/Login, Refresh Browser, Incognito
> Who Verified the Escalation?
> Brandy Kinsman
> Escalated By:
> Charlie Landeen
> Brief Description of Issue:
> Notes:
>
> The actual revenue in profit tracker is showing a payment of $11.611.68 twice. Their only payments logged are $25,746.97, but actual revenue shows $37,358.65
>
> User ID:
> Notes:
>
> mg6tpedf157crt26gbg8ruk
>
> Date/Time Issue Occurred:
> Notes:
>
> 12/18/2025
>
> Specific Record Impacted:
> Notes:
>
> Job #2871 Ami Fletcher
>
> Steps to Replicate / Steps to View:
> Notes:
>
> Profit Tracker reflects payments
>
> Expected Results:
> Notes:
>
> for the actual revenue to show only payments logged
>
> Actual Results:
> Notes:
>
> showing an additional payment.
>
> Can you Replicate in Logo's Account?
> Yes
> Did you Test in Test Account?
> No
> Can you Replicate in Test Account?(Include Email Login for Test Account if Yes)
> No
> Computer OS Type and Version (Select Type and Add Version in Notes)
> MacOS
> Browser Type and Version: (Select Type and Add Version in Notes)
> Chrome
> Notes:
>
> 143.0.7499.147

**Input 2:**
> Yes. Please create the Linear ticket using the linear ticket hybrid format.md reference.

---

## Claude's Analysis & Thinking

### Classification
- **Decision:** Backend
- **Confidence:** High
- **Reasoning:** Data aggregation showing incorrect totals ($37,358.65 vs expected $25,746.97) - this is a calculation/data issue, not UI rendering. The API is returning incorrect aggregated data.

### Investigation Steps
1. Parsed bug report - identified as Profit Tracker actual revenue discrepancy
2. Ran duplicate check on Linear - found similar issues (ACC-558 duplicate bills, SALES-509 duplicate jobs) but none matching this specific payment double-counting scenario
3. Used Explore agent to search `job-costing-frontend` and `job-costing-backend` for profit tracker code
4. Traced data flow: Frontend calls `/api/payments/v1/projects/{parentId}/payments-summary` endpoint
5. Found `projectPaymentAmount` is the aggregated total returned by backend
6. Investigated `payments-backend` repository for the aggregation logic
7. Located root cause in `ProjectsService.cs` lines 54-61

### Code Analysis
- **Repository:** payments-backend
- **Files Examined:**
  - `API/API/Modules/Projects/Services/ProjectsService.cs:49-77` - GetPaymentsSummary method containing the bug
  - `API/Core.Data/Repositories/LegacyPaymentsRepository.cs:39-45` - Direct payment query
  - `API/Core.Data/Repositories/InvoiceRepository.cs:28-37` - Invoice-linked payments query
  - `API/Core.Data/Models/LegacyPayment.cs:14-16` - Many-to-many relationship configuration
  - `API/Core.Data/Models/InvoicePaymentAmount.cs:25` - LegacyPayments collection
- **Root Cause:** Payment aggregation combines two sources (direct payments + payments via invoices) and `.DistinctBy(lp => lp.Id)` fails to deduplicate when Entity Framework loads the same payment as different object instances. The `LegacyPayment` <-> `InvoicePaymentAmount` many-to-many relationship is unusual for a join table and contributes to the issue.

### Fix Proposal
- **Approach:** Replace `.DistinctBy()` with `.GroupBy().Select(g => g.First())` for reliable deduplication regardless of object instance equality
- **Files to Change:** `API/API/Modules/Projects/Services/ProjectsService.cs` lines 58-61
- **Risks:** Low - only changes deduplication method, no business logic change

---

## Outputs

- **Linear Ticket:** [ACC-579](https://linear.app/jobnimbus/issue/ACC-579/profit-tracker-actual-revenue-double-counts-payment-when-linked-via)
- **PR Created:** Not created
- **Branch:** brandykinsman/acc-579

---

## Key Learnings

- When using Entity Framework with `.DistinctBy()`, object reference equality can fail to deduplicate records that are logically the same but loaded as separate instances
- `.GroupBy(x => x.Id).Select(g => g.First())` is more reliable for deduplication in EF contexts
- Many-to-many relationships on join tables (like `InvoicePaymentAmount`) are architecturally unusual and can lead to unexpected data retrieval patterns
- Profit Tracker actual revenue flows from `payments-backend` API endpoint `/payments/v1/projects/{projectId}/payments-summary`

---

*Session captured: 2025-12-22 16:45*
*Command Version: 371156f*
*Saved by /save-session*
